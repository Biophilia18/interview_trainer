{% extends "base.html" %}
{% block content %}
  <div class="question__meta">
    <span class="badge">{{ q.category or '未分类' }}</span>
    <span class="badge">{{ q.difficulty or '中等' }}</span>
    <span class="badge badge--ok">掌握：{{ q.level or 0 }}/5</span>
  </div>

  <p class="question__title"><b>题目：</b> {{ q.question }}</p>

  <form id="answerForm" action="{{ url_for('submit') }}" method="post">
    <input type="hidden" name="question_id" value="{{ q.id }}">
    <input type="hidden" name="duration" id="duration" value="0">

    <label for="user_answer">你的答案</label>
    <textarea id="user_answer" name="user_answer" placeholder="请输入你的答案" required rows="6"></textarea>

    <label for="rating">评分</label>
    <select id="rating" name="rating" required>
      <option value="1" selected >1 - 完全不会</option>
      <option value="2">2 - 很生疏</option>
      <option value="3">3 - 一般</option>
      <option value="4">4 - 基本掌握</option>
      <option value="5">5 - 完全掌握</option>
    </select>

    <div style="margin-top:10px;">
      <button type="submit" class="button">提交</button>
      <a class="button button--ghost" href="{{ url_for('stats') }}">查看统计</a>
      <button type="button" id="show-answer" class="button button--muted">查看参考答案</button>
    </div>
  </form>

  <!-- 参考答案区（默认隐藏） -->
  <div id="reference-answer" style="display:none; margin-top:16px; white-space:pre-wrap; background:#f7f7f7; padding:12px; border-radius:6px;">
    <strong>参考答案：</strong>
    <div style="margin-top:6px;">{{ q.answer or '（未提供参考答案）' }}</div>
  </div>

<script>
  (function(){
    // 计时起点
    var startMs = Date.now();

    // 在表单提交前写入用时（秒）
    var form = document.getElementById('answerForm');
    var durInput = document.getElementById('duration');
    form.addEventListener('submit', function(){
      var elapsedSec = Math.round((Date.now() - startMs) / 1000);
      durInput.value = elapsedSec;
      // 允许浏览器继续提交表单（不要阻止默认行为）
    });

    // 显示 / 隐藏参考答案
    var showBtn = document.getElementById('show-answer');
    var refDiv = document.getElementById('reference-answer');
    showBtn.addEventListener('click', function(){
      if (!refDiv) return;
      if (refDiv.style.display === 'none' || refDiv.style.display === '') {
        refDiv.style.display = 'block';
        showBtn.textContent = '隐藏参考答案';
      } else {
        refDiv.style.display = 'none';
        showBtn.textContent = '查看参考答案';
      }
    });

    // 可选：当用户打开参考答案后，再次提交可在 UI 上提示（不强制）
    var userAnswerArea = document.getElementById('user_answer');
    userAnswerArea.addEventListener('input', function(){
      // placeholder for advanced UX e.g. autosave; currently noop
    });
  })();
</script>
{% endblock %}
